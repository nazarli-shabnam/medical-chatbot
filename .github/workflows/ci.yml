name: Python CI

on:
    push:
        branches: [ "main" ]
    pull_request:
        branches: [ "main" ]

jobs:
    build-and-test:
        runs-on: ubuntu-latest
        
        services:
            postgres:
                image: postgres:15-alpine
                env:
                    POSTGRES_USER: medicalbot
                    POSTGRES_PASSWORD: medicalbot_password
                    POSTGRES_DB: medical_chatbot_test
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python 3.10
              uses: actions/setup-python@v4
              with:
                  python-version: '3.10'

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt
                  # Remove deprecated pinecone-plugin-inference if installed
                  # This plugin was deprecated in Pinecone SDK v6.0.0+ (inference is now built-in)
                  pip uninstall -y pinecone-plugin-inference 2>/dev/null || true

            - name: Run tests
              env:
                  DATABASE_URL: postgresql://medicalbot:medicalbot_password@localhost:5432/medical_chatbot_test
                  PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
                  GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
                  SECRET_KEY: test-secret-key-for-ci
              run: pytest

            - name: Generate coverage report
              env:
                  DATABASE_URL: postgresql://medicalbot:medicalbot_password@localhost:5432/medical_chatbot_test
                  PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
                  GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
                  SECRET_KEY: test-secret-key-for-ci
              run: |
                  pip install pytest-cov
                  pytest --cov=src --cov=app --cov-report=xml --cov-report=html

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v3
              with:
                  file: ./coverage.xml
                  flags: unittests
                  name: codecov-umbrella
              continue-on-error: true

