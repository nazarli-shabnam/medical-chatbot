{% extends "base.html" %} {% block extra_css %}
<style>
  .chat-container {
    height: 100%;
    display: flex;
    flex-direction: column;
    flex: 1;
    min-height: 0; /* Important for flex scrolling */
  }
  
  /* Adjust when flash messages are visible - using JavaScript fallback */
  body.has-flash-messages .chat-container {
    height: calc(100vh - 56px - 60px);
  }
  .messages-container {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 25px;
    background: #f7f9fc;
    -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
  }
  
  /* Mobile chat container */
  @media (max-width: 576px) {
    .chat-container {
      height: calc(100vh - 120px);
    }
  }
  .citation-badge {
    display: inline-block;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
    margin: 2px 3px;
    cursor: pointer;
    text-decoration: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
    position: relative;
    overflow: hidden;
  }
  .citation-badge::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.5s;
  }
  .citation-badge:hover {
    background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
    color: white;
    text-decoration: none;
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }
  .citation-badge:hover::before {
    left: 100%;
  }
  .citation-badge:active {
    transform: translateY(0) scale(1);
    box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
  }
  .citations-panel {
    background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
    padding: 15px;
    border-radius: 12px;
    margin-top: 15px;
    font-size: 12px;
    border: 1px solid #e8eaf6;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  }
  .citations-panel strong {
    color: #667eea;
    font-size: 13px;
    font-weight: 600;
  }
  .citation-item {
    margin: 8px 0;
    padding: 12px 15px;
    background: white;
    border-radius: 8px;
    cursor: pointer;
    border: 1px solid #e0e0e0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    position: relative;
    overflow: hidden;
  }
  .citation-item::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    width: 3px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    transform: scaleY(0);
    transition: transform 0.3s ease;
  }
  .citation-item:hover {
    background: linear-gradient(90deg, #f8f9ff 0%, #ffffff 100%);
    border-color: #667eea;
    transform: translateX(4px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
  }
  .citation-item:hover::before {
    transform: scaleY(1);
  }
  .citation-item strong {
    color: #667eea;
    font-weight: 600;
  }
  .feedback-buttons {
    margin-top: 10px;
  }
  .feedback-btn {
    background: none;
    border: 2px solid #ddd;
    padding: 5px 15px;
    border-radius: 20px;
    cursor: pointer;
    margin-right: 10px;
  }
  .feedback-btn:hover {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.05);
    transform: translateY(-1px);
  }
  .feedback-btn.active.positive {
    background: #28a745;
    border-color: #28a745;
    color: white;
  }
  .feedback-btn.active.negative {
    background: #dc3545;
    border-color: #dc3545;
    color: white;
  }
  .typing-indicator {
    display: inline-block;
  }
  .typing-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    margin: 0 2px;
    animation: typing 1.4s infinite;
  }
  .typing-dot:nth-child(2) {
    animation-delay: 0.2s;
  }
  .typing-dot:nth-child(3) {
    animation-delay: 0.4s;
  }
  @keyframes typing {
    0%,
    60%,
    100% {
      transform: translateY(0);
    }
    30% {
      transform: translateY(-10px);
    }
  }
  .advanced-rag-toggle {
    margin-bottom: 10px;
  }
  
  /* Modern History Toggle Button */
  .history-toggle-btn {
    background: rgba(255, 255, 255, 0.2);
    border: 2px solid rgba(255, 255, 255, 0.3);
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    padding: 0;
    font-size: 16px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
  
  .history-toggle-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    border-color: rgba(255, 255, 255, 0.5);
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
  }
  
  .history-toggle-btn:active {
    transform: scale(0.95);
  }
  
  .history-toggle-btn i {
    transition: transform 0.3s ease;
  }
  
  .history-toggle-btn:hover i {
    transform: rotate(15deg);
  }
  
  @media (max-width: 576px) {
    .history-toggle-btn {
      width: 36px;
      height: 36px;
      font-size: 14px;
    }
  }
  
  /* Improve input area */
  #messageForm {
    display: flex;
    gap: 10px;
  }
  
  #messageInput {
    flex: 1;
    border-radius: 25px;
    border: 2px solid #e0e0e0;
    padding: 12px 20px;
    font-size: 15px;
    transition: all 0.3s ease;
  }
  
  #messageInput:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }
  
  #sendBtn {
    border-radius: 50%;
    width: 48px;
    height: 48px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    border: none;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  #sendBtn:hover {
    background: linear-gradient(135deg, #764ba2 0%, #667eea 100%) !important;
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }
  
  #sendBtn:active {
    transform: translateY(0) scale(1);
  }
  
  @media (max-width: 576px) {
    #messageInput {
      font-size: 16px;
      padding: 10px 18px;
    }
    
    #sendBtn {
      width: 44px;
      height: 44px;
    }
  }
  
  .messages-container::-webkit-scrollbar {
    width: 8px;
  }
  
  .messages-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
  }
  
  .messages-container::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 10px;
  }
  
  .messages-container::-webkit-scrollbar-thumb:hover {
    background: #555;
  }
  
  .conversation-sidebar {
    background: #f8f9fa;
    border-right: 1px solid #dee2e6;
    height: 100%;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transition: transform 0.3s ease, opacity 0.3s ease;
  }
  
  .conversation-sidebar.hidden {
    transform: translateX(-100%);
    opacity: 0;
    width: 0 !important;
    min-width: 0 !important;
    max-width: 0 !important;
    padding: 0 !important;
    margin: 0 !important;
    border: none !important;
    overflow: hidden;
  }
  
  .conversation-sidebar-inner {
    height: 100%;
    display: flex;
    flex-direction: column;
  }
  
  .conversation-sidebar-header {
    padding: 15px;
    background: white;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .conversation-sidebar-header h6 {
    margin: 0;
    color: #495057;
    font-weight: 600;
  }
  
  .conversations-list {
    flex: 1;
    overflow-y: auto;
    padding: 10px 0;
  }
  
  .conversation-item {
    padding: 12px 15px;
    cursor: pointer;
    border-bottom: 1px solid #e9ecef;
    transition: background-color 0.2s;
    position: relative;
  }
  
  .conversation-item:hover {
    background-color: #e9ecef;
  }
  
  .conversation-item.active {
    background-color: #667eea;
    color: white;
  }
  
  .conversation-item.active .conversation-preview {
    color: rgba(255, 255, 255, 0.9);
  }
  
  .conversation-item.active .conversation-meta {
    color: rgba(255, 255, 255, 0.8);
  }
  
  .conversation-preview {
    font-size: 14px;
    color: #495057;
    margin-bottom: 5px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  .conversation-meta {
    font-size: 12px;
    color: #6c757d;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .conversation-count {
    background: #667eea;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
  }
  
  .conversation-item.active .conversation-count {
    background: rgba(255, 255, 255, 0.3);
  }
  
  .sidebar-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 999;
    display: none;
  }
  
  .sidebar-overlay.show {
    display: block;
  }
  
  .conversation-sidebar.mobile-open {
    position: fixed;
    top: 56px;
    left: 0;
    width: 280px;
    height: calc(100vh - 56px);
    z-index: 1000;
    display: block !important;
    box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
  }
  
  @media (max-width: 767px) {
    .conversation-sidebar:not(.mobile-open) {
      display: none;
    }
  }
  
  /* Adjust main chat area when sidebar is hidden */
  .conversation-sidebar.hidden ~ .col-md-9 {
    flex: 0 0 100% !important;
    max-width: 100% !important;
  }
  
  @media (min-width: 768px) {
    .conversation-sidebar.hidden ~ .col-md-9 {
      flex: 0 0 100% !important;
      max-width: 100% !important;
    }
  }
</style>
{% endblock %} {% block content %}
<div class="container-fluid chat-page-container">
  <div class="row h-100 m-0">
    <!-- Conversation History Sidebar -->
    <div class="col-md-3 col-lg-3 p-0 d-none d-md-block conversation-sidebar">
      <div class="conversation-sidebar-inner">
        <div class="conversation-sidebar-header">
          <h6 class="mb-0"><i class="fas fa-history"></i> Conversations</h6>
          <button id="newConversationBtn" class="btn btn-sm btn-primary">
            <i class="fas fa-plus"></i> New
          </button>
        </div>
        <div id="conversationsList" class="conversations-list">
          <div class="text-center text-muted p-3">
            <i class="fas fa-spinner fa-spin"></i> Loading...
								</div>
								</div>
							</div>
						</div>
    
    <button id="sidebarToggle" class="btn btn-sm btn-secondary d-md-none position-fixed" style="top: 70px; left: 10px; z-index: 1000;">
      <i class="fas fa-bars"></i>
    </button>
    
    <div id="sidebarOverlay" class="sidebar-overlay d-md-none"></div>
    
    <div class="col-12 col-md-9 col-lg-9 h-100 p-0">
      <div class="card shadow h-100">
        <div class="card-header bg-primary text-white">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-3">
              <button id="historyToggleBtn" class="history-toggle-btn" title="Toggle conversation history">
                <i class="fas fa-history"></i>
              </button>
              <div>
                <h5 class="mb-0"><i class="fas fa-robot"></i> Medical Chatbot</h5>
                <small>Powered by Gemini AI</small>
              </div>
            </div>
            <div class="advanced-rag-toggle">
              <label class="text-white">
                <input type="checkbox" id="advancedRagToggle" /> Advanced RAG
              </label>
            </div>
          </div>
        </div>
        <div class="card-body p-0 chat-container">
          <div id="messagesContainer" class="messages-container">
            <div class="text-center text-muted mt-5">
              <i class="fas fa-comments fa-3x mb-3"></i>
              <p>Start a conversation by asking a medical question</p>
            </div>
						</div>
          <div class="card-footer bg-white">
            <form id="messageForm" class="input-group">
              <input
                type="text"
                id="messageInput"
                class="form-control"
                placeholder="Type your message..."
                autocomplete="off"
                required
              />
								<div class="input-group-append">
                <button type="submit" id="sendBtn" class="btn btn-primary">
                  <i class="fas fa-paper-plane"></i>
                </button>
								</div>
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>
</div>
{% endblock %}
		
{% block extra_js %}
		<script>
  let currentConversationId = null;
  let currentMessageId = null;

  $(document).ready(function () {
    if (typeof $ === 'undefined') {
      console.error('jQuery is not loaded!');
      alert('Error: jQuery is not loaded. Please refresh the page.');
      return;
    }

    if ($("#messageForm").length === 0) {
      console.error('Form #messageForm not found!');
      return;
    }

    console.log('Chat interface initialized');

    $("#newConversationBtn").on("click", function() {
      newConversation();
    });
    
    $("#historyToggleBtn").on("click", function() {
      toggleSidebar();
    });
    
    $("#sidebarToggle").on("click", function() {
      toggleSidebar();
    });
    
    $("#sidebarOverlay").on("click", function() {
      closeMobileSidebar();
    });
    
    const isMobile = window.innerWidth < 768;
    if (!isMobile) {
      const sidebarVisible = localStorage.getItem('sidebarVisible');
      if (sidebarVisible === 'false') {
        $(".conversation-sidebar").addClass("hidden");
        updateToggleButtonIcon(false);
      } else {
        updateToggleButtonIcon(true);
      }
    } else {
      $("#historyToggleBtn").html('<i class="fas fa-history"></i>');
    }

    loadConversations();

    $("#messageForm").on("submit", function (event) {
      event.preventDefault();
      console.log('Form submitted');
      sendMessage();
    });

    $("#messageInput").on("keypress", function (e) {
      if (e.which === 13 && !e.shiftKey) {
        e.preventDefault();
        console.log('Enter key pressed');
        $("#messageForm").submit();
      }
    });
  });

  function sendMessage() {
    const message = $("#messageInput").val().trim();
    if (!message) {
      console.log('Empty message, not sending');
      return;
    }

    console.log('Sending message:', message);

    $("#messageInput").prop("disabled", true);
    $("#sendBtn").prop("disabled", true);

    addMessage("user", message);
    $("#messageInput").val("");

    const botMsgId = "msg-" + Date.now();
    const botMsgHtml = `
        <div id="${botMsgId}" class="d-flex justify-content-start mb-4">
            <div class="img_cont_msg">
                <img src="https://cdn-icons-png.flaticon.com/512/387/387569.png" class="rounded-circle user_img_msg">
            </div>
            <div class="msg_cotainer">
                <div class="message-content"></div>
                <div class="typing-indicator" style="display:none;">
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                </div>
                <span class="msg_time"></span>
            </div>
        </div>
    `;
    $("#messagesContainer").append(botMsgHtml);
    const $botMsg = $(`#${botMsgId}`);
    const $content = $botMsg.find(".message-content");
    const $typingIndicator = $botMsg.find(".typing-indicator");

    $typingIndicator.show();

    scrollToBottom();

    let fullAnswer = "";
    let citations = [];

    const useAdvancedRag = $("#advancedRagToggle").is(":checked");
    
    console.log('Making fetch request to /api/chat/stream');
    console.log('Message:', message);
    console.log('Advanced RAG:', useAdvancedRag);

    fetch("/api/chat/stream", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      credentials: "include",
      body: JSON.stringify({
        message: message,
        conversation_id: currentConversationId,
        use_advanced_rag: useAdvancedRag,
      }),
    })
      .then((response) => {
        console.log('Response received:', response.status, response.statusText);
        if (!response.ok) {
          console.error('Response not OK:', response.status, response.statusText);
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        if (!response.body) {
          console.error('Response body is null');
          throw new Error("Response body is null");
        }
        console.log('Starting to read stream');
        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        function readStream() {
          reader
            .read()
            .then(({ done, value }) => {
              if (done) {
                $typingIndicator.hide();
                $("#messageInput").prop("disabled", false);
                $("#sendBtn").prop("disabled", false);
                $("#messageInput").focus();
                return;
              }

              const chunk = decoder.decode(value);
              const lines = chunk.split("\n");

              for (const line of lines) {
                if (line.startsWith("data: ")) {
                  try {
                    const data = JSON.parse(line.substring(6));

                    if (data.type === "token") {
                      fullAnswer += data.content;
                      $content.html(formatMessage(fullAnswer));
                      $typingIndicator.hide();
                      scrollToBottom();
                    } else if (data.type === "citations") {
                      citations = data.citations;
                      currentConversationId = data.conversation_id;
                      displayCitations($botMsg, citations);
                      scrollToBottom();
                      $(".conversation-item").removeClass("active");
                      $(`.conversation-item[data-conversation-id="${currentConversationId}"]`).addClass("active");
                    } else if (data.type === "done") {
                      $typingIndicator.hide();
                      updateMessageTime($botMsg);
                      addFeedbackButtons($botMsg, data.message_id);
                      $("#messageInput").prop("disabled", false);
                      $("#sendBtn").prop("disabled", false);
                      $("#messageInput").focus();
                      loadConversations();
                    } else if (data.type === "error") {
                      $typingIndicator.hide();
                      $content.html(
                        `<span class="text-danger">Error: ${data.message}</span>`
                      );
                      $("#messageInput").prop("disabled", false);
                      $("#sendBtn").prop("disabled", false);
                    }
                  } catch (e) {
                    console.error("Error parsing SSE data:", e);
                  }
                }
              }

              readStream();
            })
            .catch((error) => {
              console.error("Stream error:", error);
              $typingIndicator.hide();
              $content.html(
                `<span class="text-danger">Connection error. Please try again.</span>`
              );
              $("#messageInput").prop("disabled", false);
              $("#sendBtn").prop("disabled", false);
            });
        }

        readStream();
      })
      .catch((error) => {
        console.error("Fetch error:", error);
        $typingIndicator.hide();
        $content.html(
          `<span class="text-danger">Connection error. Please try again.</span>`
        );
        $("#messageInput").prop("disabled", false);
        $("#sendBtn").prop("disabled", false);
      });
  }

  function addMessage(role, content, timestamp) {
    let time;
    if (timestamp) {
      time = new Date(timestamp).toLocaleTimeString([], {
        hour: "2-digit",
        minute: "2-digit",
      });
    } else {
      time = new Date().toLocaleTimeString([], {
        hour: "2-digit",
        minute: "2-digit",
      });
    }
    let html;

    if (role === "user") {
      html = `
            <div class="d-flex justify-content-end mb-4">
                <div class="msg_cotainer_send">
                    ${escapeHtml(content)}
                    <span class="msg_time_send">${time}</span>
                </div>
                <div class="img_cont_msg">
                    <img src="https://i.ibb.co/d5b84Xw/Untitled-design.png" class="rounded-circle user_img_msg">
                </div>
            </div>
        `;
    } else {
      html = `
            <div class="d-flex justify-content-start mb-4">
                <div class="img_cont_msg">
                    <img src="https://cdn-icons-png.flaticon.com/512/387/387569.png" class="rounded-circle user_img_msg">
                </div>
                <div class="msg_cotainer">
                    ${formatMessage(content)}
                    <span class="msg_time">${time}</span>
                </div>
            </div>
        `;
    }

    $("#messagesContainer .text-center").remove();
    $("#messagesContainer").append(html);
    scrollToBottom();
  }

  function formatMessage(content) {
    let formatted = escapeHtml(content);
    formatted = formatted.replace(/\[Source \d+\]/g, '');
    return formatted;
  }

  function displayCitations($messageContainer, citations) {
    if (!citations || citations.length === 0) return;

    let citationsHtml =
      '<div class="citations-panel"><strong>Sources:</strong><br>';
    citations.forEach((cit) => {
      const pageText = cit.page && cit.page !== 'N/A' ? ` (Page ${cit.page})` : '';
      citationsHtml += `
            <div class="citation-item" data-source="${cit.id}">
                <strong>${escapeHtml(cit.source)}</strong>${pageText}<br>
                <small class="text-muted">${escapeHtml(cit.preview)}</small>
            </div>
        `;
    });
    citationsHtml += "</div>";

    $messageContainer.find(".msg_cotainer").append(citationsHtml);

    $messageContainer
      .find(".citation-item")
      .on("click", function () {
        const sourceId = $(this).data("source");
        const citation = citations.find((c) => c.id === sourceId);
        if (citation) {
          const pageText = citation.page && citation.page !== 'N/A' ? `Page: ${citation.page}` : 'Page: N/A';
          alert(
            `Source: ${citation.source}\n${pageText}\n\n${citation.preview}`
          );
        }
      });
  }

  function addFeedbackButtons($messageContainer, messageId) {
    const feedbackHtml = `
        <div class="feedback-buttons">
            <button class="feedback-btn positive" data-rating="positive" data-message-id="${messageId}">
                <i class="fas fa-thumbs-up"></i> Helpful
            </button>
            <button class="feedback-btn negative" data-rating="negative" data-message-id="${messageId}">
                <i class="fas fa-thumbs-down"></i> Not Helpful
            </button>
        </div>
    `;

    $messageContainer.find(".msg_cotainer").append(feedbackHtml);

    $messageContainer.find(".feedback-btn").on("click", function () {
      const rating = $(this).data("rating");
      const msgId = $(this).data("message-id");

      if (!msgId) return;

      $messageContainer.find(".feedback-btn").removeClass("active");
      $(this).addClass("active");

					$.ajax({
        url: "/api/feedback",
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify({
          message_id: msgId,
          rating: rating,
        }),
        success: function () {
        },
				});
			});
  }

  function loadConversations() {
    $.ajax({
      url: "/api/conversations",
      method: "GET",
      success: function (conversations) {
        const $list = $("#conversationsList");
        $list.empty();
        
        if (conversations.length === 0) {
          $list.html(`
            <div class="text-center text-muted p-3">
              <i class="fas fa-comments fa-2x mb-2"></i>
              <p class="mb-0">No conversations yet</p>
              <small>Start a new conversation to begin</small>
            </div>
          `);
          return;
        }
        
        conversations.forEach(function(conv) {
          const date = new Date(conv.created_at);
          const dateStr = date.toLocaleDateString();
          const preview = conv.preview || 'No messages';
          const isActive = conv.id === currentConversationId;
          
          const $item = $(`
            <div class="conversation-item ${isActive ? 'active' : ''}" data-conversation-id="${conv.id}">
              <div class="conversation-preview">${escapeHtml(preview)}</div>
              <div class="conversation-meta">
                <span>${dateStr}</span>
                <span class="conversation-count">${conv.message_count} msgs</span>
              </div>
            </div>
          `);
          
          $item.on('click', function() {
            selectConversation(conv.id);
          });
          
          $list.append($item);
        });
        
        if (!currentConversationId && conversations.length > 0) {
          selectConversation(conversations[0].id);
        }
      },
      error: function(xhr, status, error) {
        console.error('Error loading conversations:', error);
        $("#conversationsList").html(`
          <div class="text-center text-danger p-3">
            <i class="fas fa-exclamation-triangle"></i>
            <p class="mb-0">Error loading conversations</p>
          </div>
        `);
      }
    });
  }
  
  function selectConversation(conversationId) {
    $(".conversation-item").removeClass("active");
    $(`.conversation-item[data-conversation-id="${conversationId}"]`).addClass("active");
    
    currentConversationId = conversationId;
    
    loadMessages(conversationId);
    
    closeMobileSidebar();
  }
  
  function loadMessages(conversationId) {
    if (!conversationId) {
      clearMessages();
      return;
    }
    
    $.ajax({
      url: `/api/conversations/${conversationId}/messages`,
      method: "GET",
      success: function (messages) {
        clearMessages();
        
        if (messages.length === 0) {
          $("#messagesContainer").html(`
            <div class="text-center text-muted mt-5">
              <i class="fas fa-comments fa-3x mb-3"></i>
              <p>No messages in this conversation</p>
            </div>
          `);
          return;
        }
        
        messages.forEach(function(msg) {
          if (msg.role === 'user') {
            addMessage('user', msg.content, msg.created_at);
          } else {
            const botMsgId = "msg-" + msg.id;
            const time = new Date(msg.created_at).toLocaleTimeString([], {
              hour: "2-digit",
              minute: "2-digit",
            });
            
            const botMsgHtml = `
              <div id="${botMsgId}" class="d-flex justify-content-start mb-4">
                <div class="img_cont_msg">
                  <img src="https://cdn-icons-png.flaticon.com/512/387/387569.png" class="rounded-circle user_img_msg">
                </div>
                <div class="msg_cotainer">
                  <div class="message-content">${formatMessage(msg.content)}</div>
                  <span class="msg_time">${time}</span>
                </div>
              </div>
            `;
            
            $("#messagesContainer").append(botMsgHtml);
            const $botMsg = $(`#${botMsgId}`);
            
            if (msg.citations && msg.citations.length > 0) {
              displayCitations($botMsg, msg.citations);
            }
            
            if (msg.id) {
              addFeedbackButtons($botMsg, msg.id);
              if (msg.feedback) {
                $botMsg.find(`.feedback-btn[data-rating="${msg.feedback}"]`).addClass('active');
              }
            }
          }
        });
        
        scrollToBottom();
      },
      error: function(xhr, status, error) {
        console.error('Error loading messages:', error);
        $("#messagesContainer").html(`
          <div class="text-center text-danger mt-5">
            <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
            <p>Error loading messages</p>
          </div>
        `);
      }
    });
  }
  
  function clearMessages() {
    $("#messagesContainer").empty();
  }
  
  function newConversation() {
    currentConversationId = null;
    $(".conversation-item").removeClass("active");
    clearMessages();
    $("#messagesContainer").html(`
      <div class="text-center text-muted mt-5">
        <i class="fas fa-comments fa-3x mb-3"></i>
        <p>Start a conversation by asking a medical question</p>
      </div>
    `);
    $("#messageInput").focus();
    closeMobileSidebar();
  }
  
  function openMobileSidebar() {
    $(".conversation-sidebar").removeClass("hidden").addClass("mobile-open");
    $("#sidebarOverlay").addClass("show");
  }
  
  function closeMobileSidebar() {
    $(".conversation-sidebar").removeClass("mobile-open");
    $("#sidebarOverlay").removeClass("show");
  }
  
  function toggleSidebar() {
    const $sidebar = $(".conversation-sidebar");
    const isHidden = $sidebar.hasClass("hidden");
    const isMobile = window.innerWidth < 768;
    
    if (isMobile) {
      if ($sidebar.hasClass("mobile-open")) {
        closeMobileSidebar();
      } else {
        openMobileSidebar();
      }
    } else {
      if (isHidden) {
        $sidebar.removeClass("hidden");
        localStorage.setItem('sidebarVisible', 'true');
        updateToggleButtonIcon(true);
      } else {
        $sidebar.addClass("hidden");
        localStorage.setItem('sidebarVisible', 'false');
        updateToggleButtonIcon(false);
      }
    }
  }
  
  function updateToggleButtonIcon(isVisible) {
    const $btn = $("#historyToggleBtn");
    if (isVisible) {
      $btn.html('<i class="fas fa-chevron-left"></i>');
      $btn.attr('title', 'Hide conversation history');
    } else {
      $btn.html('<i class="fas fa-chevron-right"></i>');
      $btn.attr('title', 'Show conversation history');
    }
  }
  
  $(window).on('resize', function() {
    const isMobile = window.innerWidth < 768;
    if (isMobile) {
      $("#historyToggleBtn").html('<i class="fas fa-history"></i>');
    } else {
      const sidebarVisible = localStorage.getItem('sidebarVisible') !== 'false';
      updateToggleButtonIcon(sidebarVisible);
    }
  });

  function updateMessageTime($message) {
    const time = new Date().toLocaleTimeString([], {
      hour: "2-digit",
      minute: "2-digit",
    });
    $message.find(".msg_time").text(time);
  }

  function scrollToBottom() {
    const container = document.getElementById("messagesContainer");
    container.scrollTop = container.scrollHeight;
  }

  function escapeHtml(text) {
    const map = {
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#039;",
    };
    return text.replace(/[&<>"']/g, (m) => map[m]);
  }
		</script>
{% endblock %}
        
